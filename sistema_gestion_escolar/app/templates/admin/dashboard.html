{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">Panel de Administración</h2>

    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="usuarios-tab" data-bs-toggle="tab" data-bs-target="#usuarios" type="button" role="tab" aria-controls="usuarios" aria-selected="true">Usuarios</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="docentes-tab" data-bs-toggle="tab" data-bs-target="#docentes" type="button" role="tab" aria-controls="docentes" aria-selected="false">Docentes</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="estudiantes-tab" data-bs-toggle="tab" data-bs-target="#estudiantes" type="button" role="tab" aria-controls="estudiantes" aria-selected="false">Estudiantes</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cursos-tab" data-bs-toggle="tab" data-bs-target="#cursos" type="button" role="tab" aria-controls="cursos" aria-selected="false">Cursos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="grados-tab" data-bs-toggle="tab" data-bs-target="#grados" type="button" role="tab" aria-controls="grados" aria-selected="false">Grados</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="secciones-tab" data-bs-toggle="tab" data-bs-target="#secciones" type="button" role="tab" aria-controls="secciones" aria-selected="false">Secciones</button>
        </li>
    </ul>

    <div class="tab-content" id="adminTabsContent">
        <div class="tab-pane fade show active" id="usuarios" role="tabpanel" aria-labelledby="usuarios-tab">
            <h4 class="mt-3">Gestión de Usuarios</h4>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addEditUserModal">Crear Nuevo Usuario</button>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.rol }}</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-user-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#addEditUserModal"
                                        data-username="{{ user.username }}"
                                        data-rol="{{ user.rol }}">Editar</button>
                                <a href="{{ url_for('admin_bp.eliminar_usuario', username=user.username) }}" class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro de eliminar a este usuario y todos sus datos asociados?');">Eliminar</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="docentes" role="tabpanel" aria-labelledby="docentes-tab">
            <h4 class="mt-3">Gestión de Docentes</h4>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addEditDocenteModal">Agregar Nuevo Docente</button>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Nombres</th>
                            <th>Apellidos</th>
                            <th>DNI</th>
                            <th>Correo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for docente in docentes %}
                        <tr>
                            <td>{{ docente.username }}</td>
                            <td>{{ docente.nombres }}</td>
                            <td>{{ docente.apellidos }}</td>
                            <td>{{ docente.dni }}</td>
                            <td>{{ docente.correo }}</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-docente-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#addEditDocenteModal"
                                        data-username="{{ docente.username }}"
                                        data-nombres="{{ docente.nombres }}"
                                        data-apellidos="{{ docente.apellidos }}"
                                        data-dni="{{ docente.dni }}"
                                        data-correo="{{ docente.correo }}">Editar</button>
                                <a href="{{ url_for('admin_bp.eliminar_docente', username=docente.username) }}" class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro de eliminar a este docente?');">Eliminar</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="estudiantes" role="tabpanel" aria-labelledby="estudiantes-tab">
            <h4 class="mt-3">Gestión de Estudiantes</h4>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addEditEstudianteModal">Agregar Nuevo Estudiante</button>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Nombres</th>
                            <th>Apellidos</th>
                            <th>DNI</th>
                            <th>Correo</th>
                            <th>Grado</th>
                            <th>Sección</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for estudiante in estudiantes %}
                        <tr>
                            <td>{{ estudiante.username }}</td>
                            <td>{{ estudiante.nombres }}</td>
                            <td>{{ estudiante.apellidos }}</td>
                            <td>{{ estudiante.dni }}</td>
                            <td>{{ estudiante.correo }}</td>
                            <td>{{ estudiante.grado_nombre }}</td> {# Asumimos que la ruta pasa grado_nombre #}
                            <td>{{ estudiante.seccion_nombre }}</td> {# Asumimos que la ruta pasa seccion_nombre #}
                            <td>
                                <button class="btn btn-warning btn-sm edit-estudiante-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#addEditEstudianteModal"
                                        data-username="{{ estudiante.username }}"
                                        data-nombres="{{ estudiante.nombres }}"
                                        data-apellidos="{{ estudiante.apellidos }}"
                                        data-dni="{{ estudiante.dni }}"
                                        data-correo="{{ estudiante.correo }}"
                                        data-grado-id="{{ estudiante.grado_id }}"
                                        data-seccion-id="{{ estudiante.seccion_id }}">Editar</button>
                                <a href="{{ url_for('admin_bp.eliminar_estudiante', username=estudiante.username) }}" class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro de eliminar a este estudiante y todos sus datos asociados?');">Eliminar</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="cursos" role="tabpanel" aria-labelledby="cursos-tab">
            <h4 class="mt-3">Gestión de Cursos</h4>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addEditCursoModal">Agregar Nuevo Curso</button>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre del Curso</th>
                            <th>Docente Asignado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for curso in cursos %}
                        <tr>
                            <td>{{ curso.id }}</td>
                            <td>{{ curso.nombre }}</td>
                            <td>{% if curso.docente_nombres %}{{ curso.docente_nombres }} {{ curso.docente_apellidos }}{% else %}Sin Asignar{% endif %}</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-curso-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#addEditCursoModal"
                                        data-id="{{ curso.id }}"
                                        data-nombre="{{ curso.nombre }}"
                                        data-docente-username="{{ curso.docente_username }}">Editar</button>
                                <a href="{{ url_for('admin_bp.eliminar_curso', id_curso=curso.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro de eliminar este curso?');">Eliminar</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="grados" role="tabpanel" aria-labelledby="grados-tab">
            <h4 class="mt-3">Gestión de Grados</h4>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addEditGradoModal">Agregar Nuevo Grado</button>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre del Grado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for grado in grados %}
                        <tr>
                            <td>{{ grado.id }}</td>
                            <td>{{ grado.nombre }}</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-grado-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#addEditGradoModal"
                                        data-id="{{ grado.id }}"
                                        data-nombre="{{ grado.nombre }}">Editar</button>
                                <a href="{{ url_for('admin_bp.eliminar_grado', id=grado.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro de eliminar este grado?');">Eliminar</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="secciones" role="tabpanel" aria-labelledby="secciones-tab">
            <h4 class="mt-3">Gestión de Secciones</h4>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addEditSeccionModal">Agregar Nueva Sección</button>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre de la Sección</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for seccion in secciones %}
                        <tr>
                            <td>{{ seccion.id }}</td>
                            <td>{{ seccion.nombre }}</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-seccion-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#addEditSeccionModal"
                                        data-id="{{ seccion.id }}"
                                        data-nombre="{{ seccion.nombre }}">Editar</button>
                                <a href="{{ url_for('admin_bp.eliminar_seccion', id=seccion.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro de eliminar esta sección?');">Eliminar</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addEditUserModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Crear/Editar Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="userForm" method="POST" action="{{ url_for('admin_bp.gestionar_usuarios_post') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username:</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                        <input type="hidden" id="original_username" name="original_username"> {# Para editar #}
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña (dejar en blanco para no cambiar):</label>
                        <input type="password" class="form-control" id="password" name="password">
                    </div>
                    <div class="mb-3">
                        <label for="rol" class="form-label">Rol:</label>
                        <select class="form-select" id="rol" name="rol" required>
                            <option value="admin">Administrador</option>
                            <option value="docente">Docente</option>
                            <option value="estudiante">Estudiante</option>
                        </select>
                    </div>
                    <input type="hidden" name="action" id="user_action">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addEditDocenteModal" tabindex="-1" aria-labelledby="docenteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="docenteModalLabel">Agregar/Editar Docente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="docenteForm" method="POST" action="{{ url_for('admin_bp.gestionar_docentes_post') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="docente_username" class="form-label">Username (debe existir en Usuarios):</label>
                        <input type="text" class="form-control" id="docente_username" name="username" required {% if not docentes_disponibles_para_asignar %}disabled{% endif %}>
                        {% if not docentes_disponibles_para_asignar %}
                            <small class="text-danger">No hay usuarios con rol 'docente' sin perfil de docente asignado.</small>
                        {% else %}
                            <small class="form-text text-muted">Asegúrate de haber creado primero un usuario con rol 'docente'.</small>
                        {% endif %}
                        <input type="hidden" id="original_docente_username" name="original_username">
                    </div>
                    <div class="mb-3">
                        <label for="docente_nombres" class="form-label">Nombres:</label>
                        <input type="text" class="form-control" id="docente_nombres" name="nombres" required>
                    </div>
                    <div class="mb-3">
                        <label for="docente_apellidos" class="form-label">Apellidos:</label>
                        <input type="text" class="form-control" id="docente_apellidos" name="apellidos" required>
                    </div>
                    <div class="mb-3">
                        <label for="docente_dni" class="form-label">DNI:</label>
                        <input type="text" class="form-control" id="docente_dni" name="dni" required>
                    </div>
                    <div class="mb-3">
                        <label for="docente_correo" class="form-label">Correo:</label>
                        <input type="email" class="form-control" id="docente_correo" name="correo" required>
                    </div>
                    <input type="hidden" name="action" id="docente_action">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addEditEstudianteModal" tabindex="-1" aria-labelledby="estudianteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="estudianteModalLabel">Agregar/Editar Estudiante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="estudianteForm" method="POST" action="{{ url_for('admin_bp.gestionar_estudiantes_post') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="estudiante_username" class="form-label">Username (debe existir en Usuarios):</label>
                        <input type="text" class="form-control" id="estudiante_username" name="username" required {% if not estudiantes_disponibles_para_asignar %}disabled{% endif %}>
                         {% if not estudiantes_disponibles_para_asignar %}
                            <small class="text-danger">No hay usuarios con rol 'estudiante' sin perfil de estudiante asignado.</small>
                        {% else %}
                            <small class="form-text text-muted">Asegúrate de haber creado primero un usuario con rol 'estudiante'.</small>
                        {% endif %}
                        <input type="hidden" id="original_estudiante_username" name="original_username">
                    </div>
                    <div class="mb-3">
                        <label for="estudiante_nombres" class="form-label">Nombres:</label>
                        <input type="text" class="form-control" id="estudiante_nombres" name="nombres" required>
                    </div>
                    <div class="mb-3">
                        <label for="estudiante_apellidos" class="form-label">Apellidos:</label>
                        <input type="text" class="form-control" id="estudiante_apellidos" name="apellidos" required>
                    </div>
                    <div class="mb-3">
                        <label for="estudiante_dni" class="form-label">DNI:</label>
                        <input type="text" class="form-control" id="estudiante_dni" name="dni" required>
                    </div>
                    <div class="mb-3">
                        <label for="estudiante_correo" class="form-label">Correo:</label>
                        <input type="email" class="form-control" id="estudiante_correo" name="correo" required>
                    </div>
                    <div class="mb-3">
                        <label for="estudiante_grado_id" class="form-label">Grado:</label>
                        <select class="form-select" id="estudiante_grado_id" name="grado_id" required>
                            <option value="">Seleccione un grado</option>
                            {% for grado in grados_all %}
                            <option value="{{ grado.id }}">{{ grado.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="estudiante_seccion_id" class="form-label">Sección:</label>
                        <select class="form-select" id="estudiante_seccion_id" name="seccion_id" required>
                            <option value="">Seleccione una sección</option>
                            {% for seccion in secciones_all %}
                            <option value="{{ seccion.id }}">{{ seccion.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <input type="hidden" name="action" id="estudiante_action">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addEditCursoModal" tabindex="-1" aria-labelledby="cursoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cursoModalLabel">Agregar/Editar Curso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cursoForm" method="POST" action="{{ url_for('admin_bp.gestionar_cursos_post') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="curso_nombre" class="form-label">Nombre del Curso:</label>
                        <input type="text" class="form-control" id="curso_nombre" name="nombre" required>
                        <input type="hidden" id="curso_id" name="id">
                    </div>
                    <div class="mb-3">
                        <label for="curso_docente_username" class="form-label">Docente Asignado:</label>
                        <select class="form-select" id="curso_docente_username" name="docente_username">
                            <option value="">Sin Asignar</option>
                            {% for docente in docentes_all %}
                            <option value="{{ docente.username }}">{{ docente.nombres }} {{ docente.apellidos }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <input type="hidden" name="action" id="curso_action">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addEditGradoModal" tabindex="-1" aria-labelledby="gradoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gradoModalLabel">Agregar/Editar Grado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="gradoForm" method="POST" action="{{ url_for('admin_bp.gestionar_grados_post') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="grado_nombre" class="form-label">Nombre del Grado:</label>
                        <input type="text" class="form-control" id="grado_nombre" name="nombre" required>
                        <input type="hidden" id="grado_id" name="id">
                    </div>
                    <input type="hidden" name="action" id="grado_action">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addEditSeccionModal" tabindex="-1" aria-labelledby="seccionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="seccionModalLabel">Agregar/Editar Sección</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="seccionForm" method="POST" action="{{ url_for('admin_bp.gestionar_secciones_post') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="seccion_nombre" class="form-label">Nombre de la Sección:</label>
                        <input type="text" class="form-control" id="seccion_nombre" name="nombre" required>
                        <input type="hidden" id="seccion_id" name="id">
                    </div>
                    <input type="hidden" name="action" id="seccion_action">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Funcionalidad para la activación de pestañas al cargar la página
        // (útil si redirigimos a una pestaña específica después de una acción)
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');
        if (activeTab) {
            const tabButton = document.getElementById(`${activeTab}-tab`);
            if (tabButton) {
                const bsTab = new bootstrap.Tab(tabButton);
                bsTab.show();
            }
        }


        // Script para Modal de Usuarios
        const addEditUserModal = document.getElementById('addEditUserModal');
        addEditUserModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const form = document.getElementById('userForm');
            const modalTitle = addEditUserModal.querySelector('.modal-title');
            const usernameInput = addEditUserModal.querySelector('#username');
            const originalUsernameInput = addEditUserModal.querySelector('#original_username');
            const passwordInput = addEditUserModal.querySelector('#password');
            const rolSelect = addEditUserModal.querySelector('#rol');
            const actionInput = addEditUserModal.querySelector('#user_action');

            // Resetear el formulario
            form.reset();
            passwordInput.removeAttribute('required'); // Contraseña opcional para editar
            usernameInput.removeAttribute('disabled');

            if (button.classList.contains('edit-user-btn')) {
                // Modo Edición
                modalTitle.textContent = 'Editar Usuario';
                usernameInput.value = button.dataset.username;
                originalUsernameInput.value = button.dataset.username;
                rolSelect.value = button.dataset.rol;
                actionInput.value = 'edit';
                usernameInput.setAttribute('disabled', 'true'); // No permitir cambiar username al editar directamente
            } else {
                // Modo Creación
                modalTitle.textContent = 'Crear Nuevo Usuario';
                usernameInput.value = '';
                originalUsernameInput.value = '';
                rolSelect.value = 'estudiante'; // Default
                passwordInput.setAttribute('required', 'true'); // Contraseña requerida al crear
                actionInput.value = 'create';
            }
        });


        // Script para Modal de Docentes
        const addEditDocenteModal = document.getElementById('addEditDocenteModal');
        addEditDocenteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const form = document.getElementById('docenteForm');
            const modalTitle = addEditDocenteModal.querySelector('.modal-title');
            const usernameInput = addEditDocenteModal.querySelector('#docente_username');
            const originalUsernameInput = addEditDocenteModal.querySelector('#original_docente_username');
            const nombresInput = addEditDocenteModal.querySelector('#docente_nombres');
            const apellidosInput = addEditDocenteModal.querySelector('#docente_apellidos');
            const dniInput = addEditDocenteModal.querySelector('#docente_dni');
            const correoInput = addEditDocenteModal.querySelector('#docente_correo');
            const actionInput = addEditDocenteModal.querySelector('#docente_action');

            // Resetear el formulario
            form.reset();
            usernameInput.removeAttribute('disabled'); // Habilitar por defecto para el modo crear

            if (button.classList.contains('edit-docente-btn')) {
                // Modo Edición
                modalTitle.textContent = 'Editar Docente';
                usernameInput.value = button.dataset.username;
                originalUsernameInput.value = button.dataset.username;
                nombresInput.value = button.dataset.nombres;
                apellidosInput.value = button.dataset.apellidos;
                dniInput.value = button.dataset.dni;
                correoInput.value = button.dataset.correo;
                actionInput.value = 'edit';
                usernameInput.setAttribute('disabled', 'true'); // No permitir cambiar username al editar
            } else {
                // Modo Creación
                modalTitle.textContent = 'Agregar Nuevo Docente';
                usernameInput.value = '';
                originalUsernameInput.value = '';
                nombresInput.value = '';
                apellidosInput.value = '';
                dniInput.value = '';
                correoInput.value = '';
                actionInput.value = 'create';
            }
        });


        // Script para Modal de Estudiantes
        const addEditEstudianteModal = document.getElementById('addEditEstudianteModal');
        addEditEstudianteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const form = document.getElementById('estudianteForm');
            const modalTitle = addEditEstudianteModal.querySelector('.modal-title');
            const usernameInput = addEditEstudianteModal.querySelector('#estudiante_username');
            const originalUsernameInput = addEditEstudianteModal.querySelector('#original_estudiante_username');
            const nombresInput = addEditEstudianteModal.querySelector('#estudiante_nombres');
            const apellidosInput = addEditEstudianteModal.querySelector('#estudiante_apellidos');
            const dniInput = addEditEstudianteModal.querySelector('#estudiante_dni');
            const correoInput = addEditEstudianteModal.querySelector('#estudiante_correo');
            const gradoSelect = addEditEstudianteModal.querySelector('#estudiante_grado_id');
            const seccionSelect = addEditEstudianteModal.querySelector('#estudiante_seccion_id');
            const actionInput = addEditEstudianteModal.querySelector('#estudiante_action');

            // Resetear el formulario
            form.reset();
            usernameInput.removeAttribute('disabled');

            if (button.classList.contains('edit-estudiante-btn')) {
                // Modo Edición
                modalTitle.textContent = 'Editar Estudiante';
                usernameInput.value = button.dataset.username;
                originalUsernameInput.value = button.dataset.username;
                nombresInput.value = button.dataset.nombres;
                apellidosInput.value = button.dataset.apellidos;
                dniInput.value = button.dataset.dni;
                correoInput.value = button.dataset.correo;
                gradoSelect.value = button.dataset.gradoId;
                seccionSelect.value = button.dataset.seccionId;
                actionInput.value = 'edit';
                usernameInput.setAttribute('disabled', 'true'); // No permitir cambiar username al editar
            } else {
                // Modo Creación
                modalTitle.textContent = 'Agregar Nuevo Estudiante';
                usernameInput.value = '';
                originalUsernameInput.value = '';
                nombresInput.value = '';
                apellidosInput.value = '';
                dniInput.value = '';
                correoInput.value = '';
                gradoSelect.value = '';
                seccionSelect.value = '';
                actionInput.value = 'create';
            }
        });

        // Script para Modal de Cursos
        const addEditCursoModal = document.getElementById('addEditCursoModal');
        addEditCursoModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const form = document.getElementById('cursoForm');
            const modalTitle = addEditCursoModal.querySelector('.modal-title');
            const cursoNombreInput = addEditCursoModal.querySelector('#curso_nombre');
            const cursoIdInput = addEditCursoModal.querySelector('#curso_id');
            const docenteSelect = addEditCursoModal.querySelector('#curso_docente_username');
            const actionInput = addEditCursoModal.querySelector('#curso_action');

            // Resetear el formulario
            form.reset();

            if (button.classList.contains('edit-curso-btn')) {
                // Modo Edición
                modalTitle.textContent = 'Editar Curso';
                cursoIdInput.value = button.dataset.id;
                cursoNombreInput.value = button.dataset.nombre;
                docenteSelect.value = button.dataset.docenteUsername || ''; // Manejar caso sin docente asignado
                actionInput.value = 'edit';
            } else {
                // Modo Creación
                modalTitle.textContent = 'Agregar Nuevo Curso';
                cursoIdInput.value = '';
                cursoNombreInput.value = '';
                docenteSelect.value = ''; // Sin asignar por defecto
                actionInput.value = 'create';
            }
        });

        // Script para Modal de Grados
        const addEditGradoModal = document.getElementById('addEditGradoModal');
        addEditGradoModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const form = document.getElementById('gradoForm');
            const modalTitle = addEditGradoModal.querySelector('.modal-title');
            const gradoNombreInput = addEditGradoModal.querySelector('#grado_nombre');
            const gradoIdInput = addEditGradoModal.querySelector('#grado_id');
            const actionInput = addEditGradoModal.querySelector('#grado_action');

            // Resetear el formulario
            form.reset();

            if (button.classList.contains('edit-grado-btn')) {
                // Modo Edición
                modalTitle.textContent = 'Editar Grado';
                gradoIdInput.value = button.dataset.id;
                gradoNombreInput.value = button.dataset.nombre;
                actionInput.value = 'edit';
            } else {
                // Modo Creación
                modalTitle.textContent = 'Agregar Nuevo Grado';
                gradoIdInput.value = '';
                gradoNombreInput.value = '';
                actionInput.value = 'create';
            }
        });

        // Script para Modal de Secciones
        const addEditSeccionModal = document.getElementById('addEditSeccionModal');
        addEditSeccionModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const form = document.getElementById('seccionForm');
            const modalTitle = addEditSeccionModal.querySelector('.modal-title');
            const seccionNombreInput = addEditSeccionModal.querySelector('#seccion_nombre');
            const seccionIdInput = addEditSeccionModal.querySelector('#seccion_id');
            const actionInput = addEditSeccionModal.querySelector('#seccion_action');

            // Resetear el formulario
            form.reset();

            if (button.classList.contains('edit-seccion-btn')) {
                // Modo Edición
                modalTitle.textContent = 'Editar Sección';
                seccionIdInput.value = button.dataset.id;
                seccionNombreInput.value = button.dataset.nombre;
                actionInput.value = 'edit';
            } else {
                // Modo Creación
                modalTitle.textContent = 'Agregar Nueva Sección';
                seccionIdInput.value = '';
                seccionNombreInput.value = '';
                actionInput.value = 'create';
            }
        });

        // Script para el mensaje flash
        const flashMessage = document.querySelector('.alert');
        if (flashMessage) {
            setTimeout(() => {
                flashMessage.classList.add('hide');
                flashMessage.addEventListener('transitionend', () => flashMessage.remove());
            }, 5000); // Ocultar después de 5 segundos
        }
    });
</script>
{% endblock %}